
<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">
    <title>Wine Research Survey</title>
    <!-- Bootstrap core CSS -->
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" rel="stylesheet">
    <script
  src="https://code.jquery.com/jquery-3.5.0.min.js"
  integrity="sha256-xNzN2a4ltkB44Mc/Jz3pT4iU1cmeR0FkXs4pru/JxaQ="
  crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>
    <script src="https://surveyjs.azureedge.net/1.7.4/survey.jquery.min.js"></script>
    <script type="text/javascript">
        !function(t){"use strict";function e(e,n,c){var s,f,p,d=this;return n=n||{},p=t.extend(!0,{async:!0,overwriteCache:!1,complete:null,success:null,error:function(){t(this).each(function(){t(this).html(p.errorMessage)})},errorMessage:"There was an error loading the template.",paged:!1,pageNo:1,elemPerPage:10,append:!1,prepend:!1,beforeInsert:null,afterInsert:null,bindingOptions:{ignoreUndefined:!1,ignoreNull:!1,ignoreEmptyString:!1}},c),"array"===t.type(n)?(T=!0,i.call(this,e,n,p)):(a(e)||(s=t(e),"string"==typeof e&&0===e.indexOf("#")&&(p.isFile=!1)),f=p.isFile||void 0===p.isFile&&(void 0===s||0===s.length),f&&!p.overwriteCache&&w[e]?o(e,d,n,p):f&&!p.overwriteCache&&w.hasOwnProperty(e)?r(e,d,n,p):f?l(e,d,n,p):u(s,d,n,p),this)}function n(e,n){n?P[e]=n:P=t.extend(P,e)}function a(t){return"string"==typeof t&&t.indexOf("/")>-1}function i(n,a,i){i=i||{};var r,o=this,c=a.length,s=i.prepend&&!i.append,l=0,u=0,f=!1,p=[];if(i.paged){var d=(i.pageNo-1)*i.elemPerPage;a=a.slice(d,d+i.elemPerPage),c=a.length}return i.append||i.prepend||o.html(""),r=t.extend({},i,{append:!i.prepend&&!0,complete:function(t){(++l===c||f)&&(f&&i&&"function"==typeof i.error&&i.error.call(o,p),i&&"function"==typeof i.complete&&i.complete())},success:function(){++u===c&&i&&"function"==typeof i.success&&i.success()},error:function(t){f=!0,p.push(t)}}),s&&a.reverse(),t(a).each(function(){if(e.call(o,n,this,r),f)return!1}),this}function r(t,e,n,a){k[t]?k[t].push({data:n,selection:e,settings:a}):k[t]=[{data:n,selection:e,settings:a}]}function o(t,e,n,a){var i=w[t].clone();f.call(e,i,n,a),"function"==typeof a.success&&a.success()}function c(){return(new Date).getTime()}function s(t){return-1!==t.indexOf("?")?t+"&_="+c():t+"?_="+c()}function l(e,n,a,i){w[e]=null;var r=e;i.overwriteCache&&(r=s(r)),t.ajax({url:r,async:i.async,success:function(r){d(t(r),e,n,a,i)},error:function(t){p(e,n,a,i,t)}})}function u(e,n,a,i){(e.is("script")||e.is("template"))&&(e=t.parseHTML(t.trim(e.html()))),f.call(n,e,a,i),"function"==typeof i.success&&i.success()}function f(e,n,a){h(e=t("<div/>").append(e),n,a),t(this).each(function(){var i=e.children().clone(!0);t("select",i).each(function(n,a){t(this).val(t("select",e).eq(n).val())}),a.beforeInsert&&a.beforeInsert(i,n),a.append?t(this).append(i):a.prepend?t(this).prepend(i):t(this).html("").append(i),a.afterInsert&&a.afterInsert(i,n)}),"function"==typeof a.complete&&a.complete.call(t(this),n)}function p(e,n,a,i,r){var o;for("function"==typeof i.error&&i.error.call(n,r),t(k[e]).each(function(t,e){"function"==typeof e.settings.error&&e.settings.error.call(e.selection,r)}),"function"==typeof i.complete&&i.complete.call(n);k[e]&&(o=k[e].shift());)"function"==typeof o.settings.complete&&o.settings.complete.call(o.selection);void 0!==k[e]&&k[e].length>0&&(k[e]=[])}function d(t,e,n,a,i){var r;for(w[e]=t.clone(),f.call(n,t,a,i),"function"==typeof i.success&&i.success.call(n);k[e]&&(r=k[e].shift());)f.call(r.selection,w[e].clone(),r.data,r.settings),"function"==typeof r.settings.success&&r.settings.success.call(r.selection)}function h(e,n,a){v("data-content",e,n=n||{},a,function(t,e){t.html(O(t,e,"content",a))}),v("data-content-append",e,n,a,function(t,e){t.append(O(t,e,"content",a))}),v("data-content-prepend",e,n,a,function(t,e){t.prepend(O(t,e,"content",a))}),v("data-content-text",e,n,a,function(t,e){t.text(O(t,e,"content",a))}),v("data-innerHTML",e,n,a,function(t,e){t.html(O(t,e,"content",a))}),v("data-src",e,n,a,function(t,e){t.attr("src",O(t,e,"src",a))},function(t){t.remove()}),v("data-href",e,n,a,function(t,e){t.attr("href",O(t,e,"href",a))},function(t){t.remove()}),v("data-alt",e,n,a,function(t,e){t.attr("alt",O(t,e,"alt",a))}),v("data-title",e,n,a,function(t,e){t.attr("title",O(t,e,"title",a))}),v("data-id",e,n,a,function(t,e){t.attr("id",O(t,e,"id",a))}),v("data-css",e,n,a,function(t,e){t.css(O(t,e,"css",a))}),v("data-class",e,n,a,function(t,e){t.addClass(O(t,e,"class",a))}),v("data-link",e,n,a,function(e,n){var i=t("<a/>");i.attr("href",O(e,n,"link",a)),i.html(e.html()),e.html(i)}),v("data-link-wrap",e,n,a,function(e,n){var i=t("<a/>");i.attr("href",O(e,n,"link-wrap",a)),e.wrap(i)}),v("data-options",e,n,a,function(e,n){t(n).each(function(){t("<option/>").attr("value",this).text(this).appendTo(e)})}),y(e,n,a),v("data-value",e,n,a,function(t,e){t.val(O(t,e,"value",a))})}function v(e,n,a,i,r,o){t("["+e+"]",n).each(function(){var n=t(this),c=n.attr(e),s=x(a,c);m(n,s,i)?(n.removeAttr(e),void 0!==s&&r?r(n,s):o&&o(n)):n.remove()})}function m(t,e,n){var a=g(t,n);return(!a.ignoreUndefined||void 0!==e)&&((!a.ignoreNull||null!==e)&&(!a.ignoreEmptyString||""!==e))}function g(e,n){var a={};return e instanceof jQuery&&e.attr("data-binding-options")?(a=t.parseJSON(e.attr("data-binding-options")),e.removeAttr("data-binding-options")):"object"==typeof e&&e.hasOwnProperty("bindingOptions")&&(a=e.bindingOptions),t.extend({},n.bindingOptions,a)}function y(e,n,a){t("[data-template-bind]",e).each(function(){var e=t(this),i=t.parseJSON(e.attr("data-template-bind"));e.removeAttr("data-template-bind"),t(i).each(function(){var i;if(i="object"==typeof this.value?x(n,this.value.data):x(n,this.value),this.attribute){if(!m(this,i,a))return void e.remove();switch(this.attribute){case"content":case"innerHTML":e.html(b(e,i,this));break;case"contentAppend":e.append(b(e,i,this));break;case"contentPrepend":e.prepend(b(e,i,this));break;case"contentText":e.text(b(e,i,this));break;case"options":var r=this;t(i).each(function(){t("<option/>").attr("value",this[r.value.value]).text(b(e,this[r.value.content],r)).attr("selected",void 0!=typeof this[r.value.selected]&&this[r.value.selected]).appendTo(e)});break;default:e.attr(this.attribute,b(e,i,this))}}})})}function b(t,e,n,a){return n.formatter&&P[n.formatter]?function(a){return P[n.formatter].call(t,e,n.formatOptions,a)}(a):e}function x(t,e){if("this"===e)return t;for(var n,a=e.split("."),i=t;(n=a.shift())&&void 0!==i&&null!=i;)i=i[n];return i}function O(e,n,a,i){var r,o=e.attr("data-format-target");if((o===a||!o&&"content"===a)&&(r=e.attr("data-format"))&&"function"==typeof P[r]){var c=e.attr("data-format-options");return function(a){return P[r].call(e[0],n,c,t.extend({},a))}(i)}return n}var T,w={},k={},P={};n("nestedTemplateFormatter",function(e,n,a){if(n){"string"==typeof n&&"{"===n[0]&&(n=t.parseJSON(n));var i=n.parentElement||"div",r=n.template||n;return n.parentElement?t("<"+i+"/>").loadTemplate(r,e,a):t("<"+i+"/>").loadTemplate(r,e,a).children()}}),t.fn.loadTemplate=e,t.addTemplateFormatter=n}(jQuery);
    </script>

    <style>
        #outerSurveyContainer {
            margin-top: 20px;
        }
        .table thead th {
            font-size: 12px;
            padding-right: .25rem;
        }

        input[type=radio] {
            margin-right: 5px;
        }

        #abContainer {
            margin-top: 20px;
        }

        .wine-container {
            text-align: center;
        }

        .wine-container img {
            max-width: 100%
        }

    </style>
  </head>

  <body>

    <!-- Begin page content -->
    <main role="main" class="container">
        <div id="outerSurveyContainer">
            <div id="surveyContainer"></div>
        </div>
        <div id="abContainer" style="display: none;">
            <div class="ab-instructions">
                <h3>Which of the following two wines would you be more likely to buy?</h3>
                <h6>Keep going until you're bored - the more you click, the more helpful for us!</h6>
            </div>
            <div class="row">
                <div class="col-md" id="wine-item-A">
                </div>
                <div class="col-md wine-b" id="wine-item-B">
                </div>
            </div>
        </div>
    </main>

    <script type="text/html" id="wine-card-template">
        <div class="card wine-card">
            <img class="card-img-top bottle-image" data-src="bottle_image_url">
            <div class="card-body">
                <h3 class="wine-name" data-content="name"></h3>
                <p class="wine-origin" data-content="origin"></p>
                <p class="wine-price">$<span data-content="price">13.99</span></p>
                <p class="wine-description" data-content="description"></p>

            </div>
        </div>
    </script>

    <script type="text/javascript">
        const urlParams = new URLSearchParams(window.location.search);

        if(urlParams.has('ab')) {
            showABTest();
        }
        

        Survey.StylesManager.applyTheme("bootstrap");

        var surveyJSON = {"title": "Wine Buying Survey", "description": "Thank you for your help!","pages":[{"name":"basic","elements":[{"type":"text","name":"question1","title":"Your e-mail:","valueName":"email","isRequired":true,"inputType":"email"},{"type":"text","name":"question2","title":"Your age:","valueName":"age"},{"type":"radiogroup","name":"wine_lover","title":"How much of a \"wine lover\" would you consider yourself?","valueName":"wine_love","isRequired":true,"choices":[{"value":"0","text":"Don't care for it at all"},{"value":"1","text":"Will occasionally have a glass"},{"value":"2","text":"Will buy a bottle once in a while"},{"value":"3","text":"Love a good wine tasting"},{"value":"4","text":"My wine collection is a point of pride"}]},{"type":"radiogroup","name":"wine_knowledge","title":"How much knowledge/experience would you say you have when it comes to wine?","valueName":"wine_knowledge","isRequired":true,"choices":[{"value":"0","text":"Literally none at all"},{"value":"1","text":"The basics - Cab, Chardonnay, and that's about it"},{"value":"2","text":"Reasonably informed - Know a couple varietals and regions"},{"value":"3","text":"An enthusiast - Know my specific taste, how to roughly pair, love learning more"},{"value":"4","text":"A connoisseur - friends come to me for wine knowledge"}]},{"type":"text","name":"glasses_per_month","title":"How many glasses of wine would you say you drink in an average month?","valueName":"glasses_per_month","isRequired":true,"inputType":"number"},{"type":"text","name":"bottles_per_month","title":"How many bottles of wine would you say you buy in an average month?","valueName":"bottles_per_month","isRequired":true},{"type":"text","name":"typical_price","title":"If you had to guess, how much would you say you \"typically\" spend on a bottle of wine?","description":"$","valueName":"typical_bottle_price","inputType":"number"}]},{"name":"Wine Buying","elements":[{"type":"matrix","name":"Where do you typically buy your wine?","valueName":"buying_location","columns":[{"value":"0","text":"Never"},{"value":"1","text":"Rarely"},{"value":"2","text":"Sometimes"},{"value":"3","text":"Typically"},{"value":"4","text":"Almost Always"}],"rows":[{"value":"grocery","text":"Grocery Store"},{"value":"wine_shop","text":"Wine Shop"},{"value":"tasting_room","text":"Tasting Room"},{"value":"club_membership","text":"Wine Club Membership"},{"value":"online","text":"Online"}]},{"type":"matrix","name":"wine_services","title":"Would you consider buying wine from any of the following services?","columns":[{"value":"0","text":"Haven't heard of"},{"value":"1","text":"Heard of, wouldn't consider"},{"value":"2","text":"Heard of, would consider"},{"value":"3","text":"Am a customer"}],"rows":[{"value":"winc","text":"Winc"},{"value":"nakewines","text":"NakedWines"},{"value":"vinebox","text":"Vinebox"},{"value":"nytwineclub","text":"New York Times Wine Club"},{"value":"blueapron","text":"Blue Apron Wine"},{"value":"firstleaf","text":"First Leaf"},{"value":"localshop","text":"A local wine shop website (e.g. K&L)"},{"value":"wineclub","text":"A favorite winery's club membership or website"}]},{"type":"matrix","name":"format_likelihood","title":"How likely would you buy the following formats?","valueName":"format_likelihood","columns":[{"value":"0","text":"Not at all likely"},{"value":"1","text":"Slightly likely"},{"value":"2","text":"Moderately likely"},{"value":"3","text":"Extremely likely"},{"value":"4","text":"Already do"}],"rows":[{"value":"individual_bottles_winery","text":"Individual bottles you select directly from a winery website"},{"value":"individual_bottles_site","text":"Individual bottles from a site that sells many different wines"},{"value":"monthly_nice","text":"$90 monthly subscription of 3 curated \"nice\" bottles of wine ($30/bottle)"},{"value":"monthly_value","text":"$45 monthly subscription of 3 curated \"high value\" bottles of wine ($15/bottle)"},{"value":"monthly_glass","text":"$90 monthly subscription of 9 curated wines by-the-glass ($10/glass)"},{"value":"tasting","text":"Tasting set of 6 mini-bottles for $10, that you can then choose to order full bottles of"}]},{"type":"matrix","name":"more_likely","title":"Would any of the follow make you more likely to order wine online, and how much more likely?","valueName":"more_likely","columns":[{"value":"0","text":"Less likely"},{"value":"1","text":"No influence"},{"value":"2","text":"Slightly more likely"},{"value":"3","text":"Much more likely"},{"value":"4","text":"Sign me up"}],"rows":[{"value":"taste_quiz","text":"Taste profile quiz that recommends specific bottles just for you"},{"value":"discount","text":"40% discount on your first order"},{"value":"shipping","text":"Free shipping"},{"value":"local_producers","text":"Wine from small local producers with a story"},{"value":"curated","text":"Expert curated picks"},{"value":"rare","text":"Rare or exclusive wines"},{"value":"glass","text":"Wine in by-the-glass bottles"},{"value":"cans","text":"Wine in cans"},{"value":"educational","text":"Educational material that also helps you learn more about the wine you buy and get better at tasting"}]}]}],"completeText": "Next"}
        
        var email = null;
        var abData = {};

        function showABTest() {
            $('#outerSurveyContainer').hide();
            $('#abContainer').show();
            $('#wine-item-A').click(function(){
                sendABResults('item_A');
            });
            $('#wine-item-B').click(function() {
                sendABResults('item_B')
            });
            loadNewABTest();
        }

        function loadNewABTest() {
            abData = {
                'email': email
            }

            $.getJSON('/api/get_ab_test/',
                function(data) {
                    console.log(data)
                    abData['item_A_key'] = data['item_A']['item_key'];
                    abData['item_B_key'] = data['item_B']['item_key'];

                    $('#wine-item-A').loadTemplate($('#wine-card-template'),
                        data['item_A']
                    )
                    $('#wine-item-B').loadTemplate($('#wine-card-template'),
                        data['item_B']
                    )

                    $( ".card" ).hover(
                        function() {
                            $(this).addClass('shadow-lg').css('cursor', 'pointer'); 
                        }, function() {
                            $(this).removeClass('shadow-lg');
                        }
                    );
                }
            );

        }

        function sendABResults(winner) {
            if(winner == 'item_A') {
                abData['winner'] = abData['item_A_key'];
                abData['loser'] = abData['item_B_key'];
            } else {
                abData['loser'] = abData['item_A_key'];
                abData['winner'] = abData['item_B_key'];
            }
            abData['email'] = email;
            console.log(abData);
            $.post('/api/submit_ab_results/', abData, loadNewABTest)
        }

        

        function sendDataToServer(survey) {
            console.log(survey.data);
            email = survey.data['email'];

            $.post(
                '/api/submit_survey/',
                survey.data,
                function(data) {
                    showABTest();
                }
            );
        }

        var survey = new Survey.Model(surveyJSON);
        $("#surveyContainer").Survey({
            model: survey,
            onComplete: sendDataToServer
        });
    </script>
  </body>
</html>